{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Activity Dashboard</h2>
                <a href="{% url 'activities:list' %}" class="btn btn-primary">Manage Activities</a>
            </div>

            {% if activities %}
                {% for activity in activities %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">{{ activity.name }}</h5>
                                    {% with last_log=activity.get_last_log %}
                                        {% if last_log %}
                                            <small class="text-muted">Last logged: {{ last_log.logged_at|date:"M d, Y" }}</small>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <button class="btn btn-outline-primary btn-sm" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#logActivityModal"
                                        data-activity-id="{{ activity.id }}"
                                        data-activity-name="{{ activity.name }}"
                                        data-has-categories="{{ activity.categories.exists|yesno:'true,false' }}">
                                    Log Activity
                                </button>
                            </div>
                            {% if activity.categories.all %}
                                <div class="mt-1">
                                    <small class="text-muted">Categories: 
                                        {% for category in activity.categories.all %}
                                            {{ category.name }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="activity-chart" data-activity-id="{{ activity.id }}">
                                <!-- Chart will be rendered here -->
                            </div>
                            <div class="selected-date text-muted small mt-2"></div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card">
                    <div class="card-body">
                        <p class="text-muted mb-0">No activities found. <a href="{% url 'activities:list' %}">Create one</a> to get started!</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Log Activity Modal -->
<div class="modal fade" id="logActivityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logActivityForm">
                    <input type="hidden" id="activity-id" name="activity_id">
                    <div class="mb-3">
                        <label for="log-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="log-date" name="log_date" required>
                    </div>
                    <div class="mb-3" id="category-select-container" style="display: none;">
                        <label for="category" class="form-label">Category (Optional)</label>
                        <select class="form-select" id="category" name="category_id">
                            <option value="">Select a category</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-log">Save Log</button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
.activity-chart {
    width: 100%;
    overflow-x: auto;
}

.activity-chart svg {
    min-width: 100%;
}

.activity-chart rect {
    fill: #e9ecef;
    cursor: pointer;
    transition: opacity 0.2s;
}

.activity-chart rect:hover {
    opacity: 0.8;
}

.activity-chart rect.logged {
    fill: #198754;
}

.activity-chart text {
    font-size: 12px;
    fill: #6c757d;
}

.activity-chart .week-count {
    font-size: 11px;
    fill: #495057;
    text-anchor: middle;
    dominant-baseline: text-bottom;
}

.selected-date {
    min-height: 20px;
}

.log-actions {
    white-space: nowrap;
}

.log-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.log-actions .btn + .btn {
    margin-left: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const activityData = {{ activity_data|safe|default:'{}' }};
        const year = {{ year|default:2024 }};
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Create charts for each activity
        Object.entries(activityData).forEach(([activityId, data]) => {
            try {
                createActivityChart(activityId, data, year);
            } catch (error) {
                console.error(`Error creating chart for activity ${activityId}:`, error);
            }
        });

        // Handle log deletion
        document.querySelectorAll('.delete-log').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to delete this log?')) {
                    const logId = this.getAttribute('data-log-id');
                    fetch(`/activities/logs/${logId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            location.reload();
                        } else {
                            alert('Failed to delete log. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting log:', error);
                        alert('An error occurred while deleting the log.');
                    });
                }
            });
        });

        // Handle log editing
        document.querySelectorAll('.edit-log').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const logId = this.getAttribute('data-log-id');
                const logDate = this.getAttribute('data-log-date');
                const categoryId = this.getAttribute('data-category-id');
                const activityId = this.getAttribute('data-activity-id');

                const modal = document.getElementById('logActivityModal');
                const modalInstance = new bootstrap.Modal(modal);
                
                // Set form values
                modal.querySelector('#activity-id').value = activityId;
                modal.querySelector('#log-date').value = logDate;
                
                // Set edit mode
                modal.querySelector('form').setAttribute('data-edit-mode', 'true');
                modal.querySelector('form').setAttribute('data-log-id', logId);
                modal.querySelector('.modal-title').textContent = 'Edit Activity Log';

                // Fetch categories and set selected
                if (categoryId) {
                    fetch(`/activities/api/categories/${activityId}/`)
                        .then(response => response.json())
                        .then(categories => {
                            const select = modal.querySelector('#category');
                            select.innerHTML = '<option value="">Select a category</option>';
                            categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.textContent = category.name;
                                option.selected = category.id === parseInt(categoryId);
                                select.appendChild(option);
                            });
                            modal.querySelector('#category-select-container').style.display = 'block';
                        });
                }

                modalInstance.show();
            });
        });

        // Handle save log button (modified for edit support)
        const saveButton = document.querySelector('#save-log');
        if (saveButton) {
            saveButton.addEventListener('click', function() {
                const form = document.querySelector('#logActivityForm');
                const isEdit = form.getAttribute('data-edit-mode') === 'true';
                const logId = form.getAttribute('data-log-id');
                const activityId = form.querySelector('#activity-id').value;
                const logDate = form.querySelector('#log-date').value;
                const categoryId = form.querySelector('#category').value;

                const data = new URLSearchParams();
                data.append('activity_id', activityId);
                data.append('log_date', logDate);
                if (categoryId) {
                    data.append('category_id', categoryId);
                }

                const url = isEdit ? `/activities/logs/${logId}/edit/` : '/activities/toggle-log/';
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: data
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('Failed to save log. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error saving log:', error);
                    alert('An error occurred while saving the log.');
                });
            });
        }

    } catch (error) {
        console.error('Error initializing activity dashboard:', error);
    }
});

function createActivityChart(activityId, data, year) {
    const container = document.querySelector(`.activity-chart[data-activity-id="${activityId}"]`);
    if (!container) return;

    const width = container.offsetWidth;
    const weekWidth = Math.min(25, (width - 80) / 53); // Slightly smaller squares
    const height = 55; // Reduced overall height
    const padding = 40;
    const monthY = 12; // Moved months up
    const countY = 28; // More space between months and numbers
    const squareY = 35; // More space between numbers and squares

    // Create SVG
    const svg = d3.create('svg')
        .attr('width', width)
        .attr('height', height);

    // Create date range for the year
    const startDate = new Date(Date.UTC(year, 0, 1));
    const endDate = new Date(Date.UTC(year, 11, 31));

    // Get Monday of a given date (using UTC)
    function getMondayOfWeek(date) {
        const utcDate = new Date(Date.UTC(
            date.getUTCFullYear(),
            date.getUTCMonth(),
            date.getUTCDate()
        ));
        const day = utcDate.getUTCDay();
        const diff = utcDate.getUTCDate() - day + (day === 0 ? -6 : 1);
        utcDate.setUTCDate(diff);
        return utcDate;
    }

    // Get all Mondays in the year
    function getMondays(start, end) {
        const mondays = [];
        let current = getMondayOfWeek(start);
        while (current <= end) {
            mondays.push(new Date(current));
            current.setUTCDate(current.getUTCDate() + 7);
        }
        return mondays;
    }

    const mondays = getMondays(startDate, endDate);

    // Create month labels
    const months = d3.timeMonths(startDate, endDate);
    svg.selectAll('.month')
        .data(months)
        .join('text')
        .attr('class', 'month')
        .attr('x', (d, i) => padding + (i * (width - 2 * padding) / 12))
        .attr('y', monthY)
        .text(d => d3.timeFormat('%b')(d));

    // Group logs by week
    const logsByWeek = {};
    if (data && Array.isArray(data.logs)) {
        data.logs.forEach(dateStr => {
            const date = new Date(dateStr + 'T00:00:00Z'); // Force UTC
            const monday = getMondayOfWeek(date);
            const weekKey = monday.toISOString().split('T')[0];
            logsByWeek[weekKey] = (logsByWeek[weekKey] || 0) + 1;
        });
    }

    // Create week squares
    const squares = svg.selectAll('.week-square')
        .data(mondays)
        .join('rect')
        .attr('class', 'week-square')
        .attr('x', (d, i) => padding + (i * weekWidth))
        .attr('y', squareY)
        .attr('width', weekWidth - 2)
        .attr('height', weekWidth - 2)
        .attr('rx', 2);

    // Add log counts and color squares
    squares.each(function(d) {
        const weekKey = d.toISOString().split('T')[0];
        const count = logsByWeek[weekKey] || 0;
        const square = d3.select(this);
        const squareX = parseFloat(square.attr('x'));
        
        if (count > 0) {
            const opacity = Math.min(0.4 + (count * 0.1), 1); // Darker green for more logs
            square
                .classed('logged', true)
                .style('fill-opacity', opacity);

            // Add count text above square
            svg.append('text')
                .attr('class', 'week-count')
                .attr('x', squareX + (weekWidth - 2) / 2)
                .attr('y', countY)
                .text(count);
        }
    });

    // Add hover functionality
    const dateDisplay = container.parentNode.querySelector('.selected-date');
    if (dateDisplay) {
        squares.on('mouseover', function(event, d) {
                const weekKey = d.toISOString().split('T')[0];
                const count = logsByWeek[weekKey] || 0;
                const weekEnd = new Date(d);
                weekEnd.setUTCDate(weekEnd.getUTCDate() + 6);
                const dateFormatted = `${d3.timeFormat('%b %d')(d)} - ${d3.timeFormat('%b %d')(weekEnd)}`;
                dateDisplay.textContent = `Week of ${dateFormatted}: ${count} log${count !== 1 ? 's' : ''}`;
            })
            .on('mouseout', function() {
                dateDisplay.textContent = '';
            })
            .on('click', function(event, d) {
                const weekKey = d.toISOString().split('T')[0];
                const count = logsByWeek[weekKey] || 0;
                const weekEnd = new Date(d);
                weekEnd.setUTCDate(weekEnd.getUTCDate() + 6);
                const dateFormatted = `${d3.timeFormat('%b %d')(d)} - ${d3.timeFormat('%b %d')(weekEnd)}`;
                alert(`Week of ${dateFormatted}: ${count} log${count !== 1 ? 's' : ''}`);
            });
    }

    container.appendChild(svg.node());
}

function editLog(logId, logDate, categoryId, activityId) {
    // Set form in edit mode
    const form = document.getElementById('logActivityForm');
    form.dataset.mode = 'edit';
    form.dataset.logId = logId;
    
    // Set the date and category
    document.getElementById('logDate').value = logDate;
    if (categoryId) {
        loadActivityCategories(activityId).then(() => {
            document.getElementById('categorySelect').value = categoryId;
        });
    }
    
    // Update modal title to show we're editing
    const modalTitle = document.querySelector('#logActivityModal .modal-title');
    modalTitle.textContent = 'Edit Activity Log';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('logActivityModal'));
    modal.show();
}

function deleteLog(logId) {
    if (!confirm('Are you sure you want to delete this log?')) {
        return;
    }

    fetch(`/activities/logs/${logId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the page to show updated logs
            location.reload();
        } else {
            alert('Error deleting log: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting log');
    });
}

// Update the saveLog function to handle both new logs and edits
function saveLog(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const activityId = form.dataset.activityId;
    const isEdit = form.dataset.mode === 'edit';
    const logId = form.dataset.logId;

    const data = {
        activity_id: activityId,
        log_date: formData.get('logDate'),
        category_id: formData.get('categorySelect')
    };

    const url = isEdit ? `/activities/logs/${logId}/edit/` : '/activities/toggle-log/';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the modal and refresh the page
            const modal = bootstrap.Modal.getInstance(document.getElementById('logActivityModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error saving log: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving log');
    });
}

// Helper function to get CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Update modal reset handler
document.getElementById('logActivityModal').addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('logActivityForm');
    form.dataset.mode = 'new';
    delete form.dataset.logId;
    document.querySelector('#logActivityModal .modal-title').textContent = 'Log Activity';
});
</script>
{% endblock %} 